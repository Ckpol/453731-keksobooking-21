(()=>{"use strict";(()=>{const e=document.querySelector(".map__pins"),t=getComputedStyle(e).width;window.util={MAIN_PIN_START_WIDTH:65,MAIN_PIN_START_HEIGHT:65,MAIN_PIN_START_TOP_COORD:"375px",MAIN_PIN_START_LEFT_COORD:"570px",PINS_NUMBER:5,DEBOUNCE_INTERVAL:500,PREVIEW_CONTAINER_WIDTH:70,PREVIEW_CONTAINER_HEIGHT:70,FILE_TYPES:["gif","jpg","jpeg","png"],defaultImage:"img/muffin-grey.svg",maxWidthMap:t,errorHandler:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isPopupCloseClickEvent:(e,t)=>{e.target.matches('button[class="popup__close"]')&&t()},StatusCode:{OK:200},createResponse:(e,t,o)=>{o.responseType="json",o.addEventListener("load",(()=>{if(o.status===window.util.StatusCode.OK)try{e(o.response)}catch(e){t(`Error: ${e.message}`)}else t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4},MAIN_MOUSE_BUTTON:0}})(),window.load=(e,t)=>{const o=new XMLHttpRequest;window.util.createResponse(e,t,o),o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},window.upload=(e,t,o)=>{const n=new XMLHttpRequest;window.util.createResponse(t,o,n),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)},(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("main");let n,r;const i=e=>{window.util.isEscEvent(e,a)},s=()=>{a()},a=()=>{const e=o.querySelector(".success"),t=o.querySelector(".error");e&&e.remove(),t&&t.remove(),document.removeEventListener("keydown",i),n.removeEventListener("click",s),r&&r.removeEventListener("click",s)};window.uploadMessages={showSuccess:()=>{const t=e.cloneNode(!0);o.appendChild(t),n=o.querySelector(".success"),document.addEventListener("keydown",i),n.addEventListener("click",s)},showError:()=>{const e=t.cloneNode(!0);o.appendChild(e),n=o.querySelector(".error"),r=n.querySelector(".error__button"),document.addEventListener("keydown",i),n.addEventListener("click",s),r.addEventListener("click",s)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.left=+e.location.x-25+"px",o.style.top=+e.location.y-70+"px",n.src=`${e.author.avatar}`,n.alt=`${e.offer.title}`,o};window.pin={render:t=>{const n=document.createDocumentFragment(),r=Math.min(t.length,window.util.PINS_NUMBER);if(Array.isArray(t)){for(let e=0;e<r;e++)t[e]&&t[e].offer&&n.appendChild(o(t[e]));e.appendChild(n),window.main.currentPins=t}}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t={BUNGALOW:"Бунгало",FLAT:"Квартира",HOUSE:"Дом",PALACE:"Дворец",ANY:"Любой тип жилья"};window.card={offerPrice:[{title:"any",minValue:"",maxValue:""},{title:"middle",minValue:"10000",maxValue:"50000"},{title:"low",minValue:"",maxValue:"10000"},{title:"high",minValue:"50000",maxValue:1/0}],createPinInfo:o=>{const n=e.cloneNode(!0),r=n.querySelector(".popup__title"),i=n.querySelector(".popup__text--address"),s=n.querySelector(".popup__text--price"),a=n.querySelector(".popup__type"),d=n.querySelector(".popup__text--capacity"),l=n.querySelector(".popup__text--time"),c=n.querySelector(".popup__features"),u=n.querySelector(".popup__description"),m=n.querySelector(".popup__photos"),p=n.querySelector(".popup__avatar"),w=c.querySelectorAll(".popup__feature"),f=m.querySelector(".popup__photo"),_=n.querySelectorAll(".popup__text");Array.from(w).map((e=>{const t=e.className.split("--")[1];o.offer.features.includes(t)||e.classList.add("hidden")})),r.textContent=`${o.offer.title}`,i.textContent=`${o.offer.address}`,s.textContent=`${o.offer.price} ₽/ночь`,a.textContent=t[`${o.offer.type.toUpperCase()}`],d.textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,l.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,u.textContent=`${o.offer.description}`,o.offer.photos.forEach(((e,t)=>{if(0===t&&(f.src=e),o.offer.photos.length>1&&t>=1){const t=f.cloneNode(!0);t.src=e,m.appendChild(t)}})),p.src=`${o.author.avatar}`;for(let e in o.offer)if(""===o.offer[e]||0===o.offer[e].length){const t=n.querySelector(`.popup__${e}`);_.forEach((t=>{t.classList.contains(`popup__text--${e}`)&&t.classList.add("hidden")})),t.classList.add("hidden")}return n}}})(),(()=>{const e=0-Math.floor(32.5),t=parseInt(window.util.maxWidthMap,10)-Math.floor(32.5),o=document.querySelector(".map"),n=document.querySelector(".map__pins"),r=n.querySelector(".map__pin--main");window.move={map:o,pinsList:n,mainPin:r,onMainPinEnter:e=>{"Enter"!==e.key&&" "!==e.key||!o.classList.contains("map--faded")||(window.main.changeToActive(o,window.form.offer,window.form.offerElements),window.form.setAddress(r,65,70))},onMainPinClick:i=>{i.preventDefault(),i.button===window.util.MAIN_MOUSE_BUTTON&&o.classList.contains("map--faded")&&(window.main.changeToActive(o,window.form.offer,window.form.offerElements),window.form.setAddress(r,65,70));let s={x:i.clientX,y:i.clientY};const a=o=>{o.preventDefault();const n=s.x-o.clientX,i=s.y-o.clientY;s={x:o.x,y:o.y};let a=r.offsetTop-i,d=r.offsetLeft-n;a>560?a=560:a<60&&(a=60),d>t?d=t:d<e&&(d=e),r.style.top=a+"px",r.style.left=d+"px",window.form.setAddress(r,65,70)},d=e=>{e.preventDefault(),window.form.setAddress(r,65,70),n.removeEventListener("mousemove",a),n.removeEventListener("mouseup",d)};n.addEventListener("mousemove",a),n.addEventListener("mouseup",d)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),n=e=>{window.util.isEscEvent(e,s)},r=e=>{window.util.isPopupCloseClickEvent(e,s)},i=(t,o)=>{o.before(window.card.createPinInfo(t));const i=e.querySelector(".map__card");document.addEventListener("keydown",n),i.addEventListener("click",r)},s=()=>{const o=e.querySelector(".map__card"),i=t.querySelectorAll(".map__pin");o&&(o.remove(),Array.from(i).find((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")})),o.removeEventListener("click",r)),document.removeEventListener("keydown",n)};window.map={pinsList:t,clear:e=>{const t=e.querySelectorAll("button");s(),Array.from(t).map(((e,t)=>{t>=1&&e.remove()}))},onPinClick:e=>{const n=e.target.matches("img"),r=e.target.parentNode.classList.contains("map__pin--main"),a=e.target.parentNode.classList.contains("map__pin"),d=e.target.matches('button[class="map__pin"]');if(n&&r)e.preventDefault();else if(n&&a||d){const n=t.querySelectorAll(".map__pin");Array.from(n).map((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")})),s();const r=Array.from(n).findIndex((t=>(e.target===t||e.target.parentNode===t)&&(t.classList.add("map__pin--active"),!0)));i(window.main.currentPins[r-1],o)}},onPinEnterPress:e=>{if(e.target.matches('button[class="map__pin"]'))if("Enter"===e.key){const n=t.querySelectorAll(".map__pin"),r=Array.from(n).findIndex((t=>e.target===t));s(),i(window.main.currentPins[r-1],o)}else" "===e.key&&e.preventDefault()}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters"),o=e.querySelector("#address"),n=e.querySelectorAll("fieldset"),r=e.querySelector("#title"),i=e.querySelector("#price"),s=e.querySelector("#room_number"),a=e.querySelector("#capacity"),d=e.querySelector("#type"),l=e.querySelector("#timein"),c=e.querySelector("#timeout"),u=e.querySelector(".ad-form__reset"),m=t.querySelector(".map__features"),p=e.querySelector(".features"),w=e.querySelector(".ad-form__photo"),f={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4};r.addEventListener("input",(()=>{const e=r.value.length;e<30?r.setCustomValidity(`Ещё ${30-e} симв.`):e>100?r.setCustomValidity(`Удалите лишние ${e-100} симв.`):r.setCustomValidity(""),r.reportValidity()})),d.addEventListener("change",(e=>{((e,t,o)=>{for(let n in t)n.toLowerCase()===e&&(o.setAttribute("min",t[n]),o.setAttribute("placeholder",t[n]))})(e.target.value,f,i)})),i.addEventListener("input",(()=>{i.value>1e6?i.setCustomValidity("Значение должно быть меньше или равно 1000000"):i.setCustomValidity(""),i.reportValidity()}));const _=()=>{const e=s.value,t=a.value;"1"===e&&"1"!==t?a.setCustomValidity("Недопустимый вариант для данного количества комнат"):"2"!==e||"0"!==t&&"3"!==t?"3"===e&&"0"===t?a.setCustomValidity("Недопустимый вариант для данного количества комнат 3"):"100"===e&&"0"!==t?a.setCustomValidity("Недопустимый вариант для данного количества комнат 100"):a.setCustomValidity(""):a.setCustomValidity("Недопустимый вариант для данного количества комнат 2"),a.reportValidity()};s.addEventListener("change",_),a.addEventListener("change",_),l.addEventListener("change",(e=>{const t=e.target;y(t,c)})),c.addEventListener("change",(e=>{const t=e.target;y(t,l)}));const y=(e,t)=>{e.matches('select[id="timein"]')&&(t.selectedIndex=e.selectedIndex),e.matches('select[id="timeout"]')&&(t.selectedIndex=e.selectedIndex)};p.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.target.checked=!e.target.checked,e.preventDefault())})),window.form={offer:e,offerElements:n,filters:t,filtersElements:t.children,offerResetButton:u,clear:e=>{const t=e,o=window.avatar.previewImg,n=t.querySelector("#price");o&&(o.src=window.util.defaultImage),n&&(n.setAttribute("min",f.FLAT),n.setAttribute("placeholder",f.FLAT)),w.children.length>0&&w.removeChild(w.children[0]),t.reset()},setAddress:(e,t,n)=>{let r=getComputedStyle(e).left,i=getComputedStyle(e).top;r=parseInt(r,10)+Math.floor(t/2),window.move.map.classList.contains("map--faded")&&(n=Math.floor(n/2)),i=parseInt(i,10)+n,o.value=r+", "+i},filterFeatures:m,photosContainer:w}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=window.form.filters.querySelectorAll(".map__checkbox"),t=window.form.filters.querySelectorAll(".map__filter"),o=window.debounce((e=>{s(e)}));let n,r,i={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any",features:[]};const s=e=>{const t="any"!==i["housing-type"],o="any"!==i["housing-price"],s="any"!==i["housing-rooms"],a="any"!==i["housing-guests"];let d=[];if(0!==e.length){for(let l=0;l<e.length;l++){let c=!0;if((e[l].offer.type===i["housing-type"]||!t)&&(!o||n<=e[l].offer.price&&r>=e[l].offer.price)&&(!s||e[l].offer.rooms===parseInt(i["housing-rooms"],10))&&(!a||e[l].offer.guests===parseInt(i["housing-guests"],10))&&(i.features.forEach((t=>{e[l].offer.features.includes(t)||(c=!1)})),c&&(d.push(e[l]),d.lenght>=window.util.PINS_NUMBER)))break}window.map.clear(window.move.pinsList),window.pin.render(d)}};window.pinsFilter={saveData:()=>{Array.from(t).forEach((e=>{i[e.id]=e.value,"housing-price"===e.id&&window.card.offerPrice.forEach((t=>{e.value===t.title&&(n=t.minValue,r=t.maxValue)}))})),i.features=[],e.forEach((e=>{!0===e.checked&&i.features.push(e.value)}))},updateWithDebounce:o}})(),(()=>{let e=[];const t=t=>{e=t,t.length>0&&(window.form.filters.classList.remove("map__filters--disabled"),Array.from(window.form.filtersElements).map((e=>{e.removeAttribute("disabled")}))),window.pin.render(e)},o=(e,t,o,n,r)=>{e.classList.contains("map--faded")||e.classList.add("map--faded"),t.classList.contains("ad-form--disabled")||t.classList.add("ad-form--disabled"),n.classList.contains("map__filters--disabled")||n.classList.add("map__filters--disabled"),window.form.clear(t),Array.from(o).map((e=>{e.setAttribute("disabled","disabled")})),window.form.clear(n),Array.from(r).map((e=>{e.setAttribute("disabled","disabled")})),window.map.clear(window.move.pinsList),window.move.mainPin.style.top=window.util.MAIN_PIN_START_TOP_COORD,window.move.mainPin.style.left=window.util.MAIN_PIN_START_LEFT_COORD,window.form.setAddress(window.move.mainPin,window.util.MAIN_PIN_START_WIDTH,window.util.MAIN_PIN_START_HEIGHT)};o(window.move.map,window.form.offer,window.form.offerElements,window.form.filters,window.form.filtersElements),window.form.setAddress(window.move.mainPin,window.util.MAIN_PIN_START_WIDTH,window.util.MAIN_PIN_START_HEIGHT),window.move.mainPin.addEventListener("mousedown",window.move.onMainPinClick),window.move.mainPin.addEventListener("keydown",window.move.onMainPinEnter),window.map.pinsList.addEventListener("click",(e=>{window.map.onPinClick(e)})),window.map.pinsList.addEventListener("keydown",(e=>{window.map.onPinEnterPress(e)})),window.form.offer.addEventListener("submit",(e=>{window.upload(new FormData(window.form.offer),(()=>{o(window.move.map,window.form.offer,window.form.offerElements,window.form.filters,window.form.filtersElements),window.uploadMessages.showSuccess()}),window.uploadMessages.showError),e.preventDefault()})),window.form.offerResetButton.addEventListener("click",(e=>{e.preventDefault(),o(window.move.map,window.form.offer,window.form.offerElements,window.form.filters,window.form.filtersElements)})),window.form.filterFeatures.addEventListener("keydown",(t=>{"Enter"===t.key&&(t.target.checked=!t.target.checked,window.pinsFilter.saveData(),window.pinsFilter.updateWithDebounce(e))})),window.form.filters.addEventListener("change",(()=>{window.pinsFilter.saveData(),window.pinsFilter.updateWithDebounce(e)})),window.main={changeToInactive:o,changeToActive:(e,o,n)=>{e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),Array.from(n).map((e=>{e.removeAttribute("disabled")})),window.load(t,window.util.errorHandler)},pins:e,currentPins:[]}})(),(()=>{const e=window.form.offer.querySelector(".ad-form-header__input"),t=window.form.offer.querySelector(".ad-form-header__preview").querySelector("img");e.addEventListener("change",(()=>{if(0===e.files.length)return;const o=e.files[0],n=o.name.toLowerCase();if(window.util.FILE_TYPES.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(o)}})),window.avatar={previewImg:t}})(),(()=>{const e=window.form.offer.querySelector(".ad-form__input");let t;e.addEventListener("change",(()=>{if(0===e.files.length)return;const o=e.files[0],n=o.name.toLowerCase(),r=window.util.FILE_TYPES.some((e=>n.endsWith(e)));if(window.form.photosContainer.children.length>0&&window.form.photosContainer.removeChild(t),r){const e=new FileReader;e.addEventListener("load",(()=>{const o=document.createElement("img");t=o,o.width=window.util.PREVIEW_CONTAINER_WIDTH,o.height=window.util.PREVIEW_CONTAINER_HEIGHT,o.alt="Фотография помещения",o.src=e.result,window.form.photosContainer.insertAdjacentElement("afterbegin",o)})),e.readAsDataURL(o)}}))})()})();